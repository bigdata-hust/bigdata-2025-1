# ğŸ—ï¸ KIáº¾N TRÃšC Há»† THá»NG - YELP BIG DATA ANALYSIS

## ğŸ“ SÆ¡ Ä‘á»“ tá»•ng quan 3 táº§ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APPLICATION LAYER                          â”‚
â”‚                    (Entry Points & UI)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ batch_main.py  â”‚              â”‚batch_main_v2.py â”‚           â”‚
â”‚  â”‚                â”‚              â”‚                 â”‚           â”‚
â”‚  â”‚  7 Analyses    â”‚              â”‚  9 Analyses     â”‚           â”‚
â”‚  â”‚  (Basic)       â”‚              â”‚  (Advanced) â­  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                               â”‚                    â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                           â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BUSINESS LOGIC LAYER                       â”‚
â”‚                 (Orchestration & Analytics)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           batch_pipeline.py                              â”‚  â”‚
â”‚  â”‚      YelpAnalysisPipeline (Orchestrator)                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â€¢ load_data()                                            â”‚  â”‚
â”‚  â”‚  â€¢ run_analysis_1() ... run_analysis_7()                 â”‚  â”‚
â”‚  â”‚  â€¢ run_all_analyses()                                    â”‚  â”‚
â”‚  â”‚  â€¢ save_results()                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                           â”‚            â”‚
â”‚        â–¼                                           â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚batch_analytics  â”‚                    â”‚batch_analytics_  â”‚   â”‚
â”‚  â”‚     .py         â”‚                    â”‚  advanced.py â­  â”‚   â”‚
â”‚  â”‚                 â”‚                    â”‚                  â”‚   â”‚
â”‚  â”‚ YelpAnalytics   â”‚                    â”‚AdvancedYelp      â”‚   â”‚
â”‚  â”‚                 â”‚                    â”‚  Analytics       â”‚   â”‚
â”‚  â”‚ â€¢ Analysis 1-7  â”‚                    â”‚                  â”‚   â”‚
â”‚  â”‚ â€¢ Broadcast     â”‚                    â”‚ â€¢ Analysis 8     â”‚   â”‚
â”‚  â”‚   Join          â”‚                    â”‚   (Window Fns)   â”‚   â”‚
â”‚  â”‚ â€¢ Caching       â”‚                    â”‚ â€¢ Analysis 9     â”‚   â”‚
â”‚  â”‚ â€¢ Salted Agg    â”‚                    â”‚   (Pivot/Unpiv)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                   â”‚             â”‚
â”‚                                                   â–¼             â”‚
â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                         â”‚  batch_udf.py â­ â”‚   â”‚
â”‚                                         â”‚                  â”‚   â”‚
â”‚                                         â”‚ â€¢ 3 Regular UDFs â”‚   â”‚
â”‚                                         â”‚ â€¢ 4 Pandas UDFs  â”‚   â”‚
â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       DATA ACCESS LAYER                         â”‚
â”‚                  (Configuration & Loading)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚batch_configuration â”‚          â”‚  batch_load_data.py  â”‚      â”‚
â”‚  â”‚       .py          â”‚          â”‚                      â”‚      â”‚
â”‚  â”‚                    â”‚          â”‚   DataLoader         â”‚      â”‚
â”‚  â”‚ SparkConfig        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚      â”‚
â”‚  â”‚ â€¢ Spark Session    â”‚          â”‚ â€¢ load_business()    â”‚      â”‚
â”‚  â”‚ â€¢ Memory Config    â”‚          â”‚ â€¢ load_review()      â”‚      â”‚
â”‚  â”‚                    â”‚          â”‚ â€¢ load_user()        â”‚      â”‚
â”‚  â”‚ DataSchemas        â”‚          â”‚                      â”‚      â”‚
â”‚  â”‚ â€¢ business_schema()â”‚          â”‚                      â”‚      â”‚
â”‚  â”‚ â€¢ review_schema()  â”‚          â”‚                      â”‚      â”‚
â”‚  â”‚ â€¢ user_schema()    â”‚          â”‚                      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚            â”‚                                 â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                 â”‚
             â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATA SOURCES                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ“ business.json          ğŸ“ review.json         ğŸ“ user.json  â”‚
â”‚  (150K+ records)           (7M+ records)          (2M+ records) â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow - Luá»“ng xá»­ lÃ½ dá»¯ liá»‡u

### Flow 1: Khá»Ÿi Ä‘á»™ng Pipeline V2
```
USER
  â”‚
  â”‚ python batch_main_v2.py --data-path ./data/
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ batch_main_v2.py â”‚
â”‚   main()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. Parse arguments
         â”‚ 2. Create EnhancedYelpPipeline
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EnhancedYelpPipeline    â”‚
â”‚ __init__()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 3. Create Spark Session
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SparkConfig             â”‚
â”‚ create_spark_session()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 4. Initialize DataLoader
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataLoader              â”‚
â”‚ __init__(spark, path)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 5. Load datasets
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ load_data()             â”‚
â”‚ â€¢ business_df           â”‚
â”‚ â€¢ review_df             â”‚
â”‚ â€¢ user_df (optional)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 6. Run all analyses
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ run_all_analyses_v2()   â”‚
â”‚                         â”‚
â”‚ â”œâ”€â–º Analysis 1 (Basic)  â”‚
â”‚ â”œâ”€â–º Analysis 2 (Basic)  â”‚
â”‚ â”œâ”€â–º Analysis 3 (Basic)  â”‚
â”‚ â”œâ”€â–º Analysis 4 (Basic)  â”‚
â”‚ â”œâ”€â–º Analysis 5 (Basic)  â”‚
â”‚ â”œâ”€â–º Analysis 6 (Basic)  â”‚
â”‚ â”œâ”€â–º Analysis 7 (Basic)  â”‚
â”‚ â”œâ”€â–º Analysis 8 (Window) â”‚
â”‚ â””â”€â–º Analysis 9 (Pivot)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 7. Save results
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ save_results()          â”‚
â”‚ â€¢ output_v2/*.csv       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flow 2: Thá»±c thi má»™t Analysis
```
Pipeline.run_analysis_8()
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AdvancedYelpAnalytics                â”‚
â”‚ trending_businesses(                 â”‚
â”‚   review_df, business_df             â”‚
â”‚ )                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. Filter recent reviews
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ recent_df = review_df.filter(        â”‚
â”‚   col("review_date") >= cutoff_date  â”‚
â”‚ )                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 2. Group by business & week
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ weekly_reviews = groupBy(            â”‚
â”‚   "business_id",                     â”‚
â”‚   window("review_date", "7 days")    â”‚
â”‚ ).agg(count("review_id"))            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 3. Apply Window Functions
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ windowSpec = Window.partitionBy(     â”‚
â”‚   "business_id"                      â”‚
â”‚ ).orderBy("week_start")              â”‚
â”‚                                      â”‚
â”‚ trending = weekly_reviews            â”‚
â”‚   .withColumn("prev_week_count",     â”‚
â”‚     lag("weekly_count", 1)           â”‚
â”‚       .over(windowSpec)              â”‚
â”‚   )                                  â”‚
â”‚   .withColumn("growth_rate",         â”‚
â”‚     (col("weekly_count") -           â”‚
â”‚      col("prev_week_count")) /       â”‚
â”‚     col("prev_week_count")           â”‚
â”‚   )                                  â”‚
â”‚   .withColumn("avg_last_4_weeks",    â”‚
â”‚     avg("weekly_count")              â”‚
â”‚       .over(windowSpec               â”‚
â”‚         .rowsBetween(-3, 0))         â”‚
â”‚   )                                  â”‚
â”‚   .withColumn("trend_rank",          â”‚
â”‚     dense_rank().over(               â”‚
â”‚       Window.orderBy(                â”‚
â”‚         desc("growth_rate")          â”‚
â”‚       )                              â”‚
â”‚     )                                â”‚
â”‚   )                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 4. Join vá»›i business info
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ result = trending.join(              â”‚
â”‚   business_df,                       â”‚
â”‚   "business_id"                      â”‚
â”‚ )                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 5. Return top N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ return result                        â”‚
â”‚   .filter(col("trend_rank") <= 10)  â”‚
â”‚   .orderBy("trend_rank")             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flow 3: Sá»­ dá»¥ng UDF
```
Analysis Function
         â”‚
         â”‚ Need sentiment analysis
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ from batch_udf import sentiment_scoreâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Apply Pandas UDF
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ df = df.withColumn(                  â”‚
â”‚   "sentiment",                       â”‚
â”‚   sentiment_score(col("text"))       â”‚
â”‚ )                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Vectorized processing
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @pandas_udf(FloatType())             â”‚
â”‚ def sentiment_score(                 â”‚
â”‚   text: pd.Series                    â”‚
â”‚ ) -> pd.Series:                      â”‚
â”‚                                      â”‚
â”‚   # Process entire Series at once    â”‚
â”‚   # 10-100x faster than row-by-row  â”‚
â”‚                                      â”‚
â”‚   return text.apply(                 â”‚
â”‚     calculate_score                  â”‚
â”‚   )                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Return enriched DataFrame
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ df (with sentiment column)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© Module Dependencies - Quan há»‡ phá»¥ thuá»™c

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ batch_main_v2.pyâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ imports
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
              â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚batch_pipelineâ”‚  â”‚batch_      â”‚  â”‚(test files) â”‚
    â”‚    .py       â”‚  â”‚analytics_  â”‚  â”‚             â”‚
    â”‚              â”‚  â”‚advanced.py â”‚  â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ imports        â”‚ imports
           â”‚                â”‚
      â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”          â”‚
      â”‚    â”‚    â”‚          â”‚
      â–¼    â–¼    â–¼          â–¼
    â”Œâ”€â”€â”€â”â”Œâ”€â”€â”€â”â”Œâ”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚cfgâ”‚â”‚ldrâ”‚â”‚anlâ”‚  â”‚batch_udf â”‚
    â”‚   â”‚â”‚   â”‚â”‚   â”‚  â”‚   .py    â”‚
    â””â”€â”¬â”€â”˜â””â”€â”€â”€â”˜â””â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ uses
      â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ PySpark â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
  cfg = batch_configuration.py
  ldr = batch_load_data.py
  anl = batch_analytics.py
```

### Import Hierarchy (tá»« trÃªn xuá»‘ng dÆ°á»›i)

```
Level 0 (External):
  â””â”€ pyspark, pandas, pyarrow

Level 1 (Configuration):
  â””â”€ batch_configuration.py

Level 2 (Data Access):
  â””â”€ batch_load_data.py
      â””â”€ depends on: batch_configuration

Level 3 (Business Logic):
  â”œâ”€ batch_analytics.py
  â”‚   â””â”€ depends on: pyspark.sql.functions
  â”œâ”€ batch_udf.py
  â”‚   â””â”€ depends on: pyspark.sql.functions, pandas
  â””â”€ batch_analytics_advanced.py
      â””â”€ depends on: batch_udf

Level 4 (Orchestration):
  â””â”€ batch_pipeline.py
      â””â”€ depends on: batch_configuration, batch_load_data, batch_analytics

Level 5 (Application):
  â”œâ”€ batch_main.py
  â”‚   â””â”€ depends on: batch_pipeline
  â””â”€ batch_main_v2.py
      â””â”€ depends on: batch_pipeline, batch_analytics_advanced
```

---

## ğŸ¯ Function Call Graph - Chuá»—i gá»i hÃ m

### Scenario: Cháº¡y Analysis 8 (Trending Businesses)

```
USER: python batch_main_v2.py --data-path ./data/
  â”‚
  â””â”€â–º batch_main_v2.main()
        â”‚
        â”œâ”€â–º argparse.ArgumentParser.parse_args()
        â”‚
        â”œâ”€â–º EnhancedYelpPipeline.__init__()
        â”‚     â”‚
        â”‚     â”œâ”€â–º SparkConfig.create_spark_session()
        â”‚     â”‚     â””â”€â–º SparkSession.builder.config(...).getOrCreate()
        â”‚     â”‚
        â”‚     â”œâ”€â–º DataLoader.__init__(spark, data_path)
        â”‚     â”‚
        â”‚     â””â”€â–º YelpAnalytics.__init__()
        â”‚
        â”œâ”€â–º pipeline.load_data()
        â”‚     â”‚
        â”‚     â”œâ”€â–º DataLoader.load_business_data()
        â”‚     â”‚     â””â”€â–º spark.read.schema(...).json("business.json")
        â”‚     â”‚
        â”‚     â””â”€â–º DataLoader.load_review_data()
        â”‚           â””â”€â–º spark.read.schema(...).json("review.json")
        â”‚
        â”œâ”€â–º pipeline.run_all_analyses_v2()
        â”‚     â”‚
        â”‚     â”œâ”€â–º pipeline.run_analysis_1()  # Basic
        â”‚     â”œâ”€â–º pipeline.run_analysis_2()  # Basic
        â”‚     â”œâ”€â–º ...
        â”‚     â”œâ”€â–º pipeline.run_analysis_7()  # Basic
        â”‚     â”‚
        â”‚     â”œâ”€â–º pipeline.run_analysis_8()  â—„â”€â”€ ANALYSIS 8
        â”‚     â”‚     â”‚
        â”‚     â”‚     â””â”€â–º AdvancedYelpAnalytics.trending_businesses()
        â”‚     â”‚           â”‚
        â”‚     â”‚           â”œâ”€â–º DataFrame.filter()
        â”‚     â”‚           â”œâ”€â–º DataFrame.groupBy().agg()
        â”‚     â”‚           â”œâ”€â–º Window.partitionBy().orderBy()
        â”‚     â”‚           â”œâ”€â–º DataFrame.withColumn(lag())
        â”‚     â”‚           â”œâ”€â–º DataFrame.withColumn(avg().over())
        â”‚     â”‚           â”œâ”€â–º DataFrame.withColumn(dense_rank())
        â”‚     â”‚           â”œâ”€â–º DataFrame.join()
        â”‚     â”‚           â”œâ”€â–º DataFrame.filter()
        â”‚     â”‚           â””â”€â–º DataFrame.orderBy()
        â”‚     â”‚
        â”‚     â””â”€â–º pipeline.run_analysis_9()  # Pivot/Unpivot
        â”‚
        â”œâ”€â–º pipeline.save_results()
        â”‚     â””â”€â–º DataFrame.coalesce(1).write.csv()
        â”‚
        â””â”€â–º print_footer()
```

---

## ğŸ“¦ Class Diagram - SÆ¡ Ä‘á»“ lá»›p

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SparkConfig                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ @staticmethod                                                â”‚
â”‚ + create_spark_session(): SparkSession                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DataSchemas                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ @staticmethod                                                â”‚
â”‚ + business_schema(): StructType                              â”‚
â”‚ + review_schema(): StructType                                â”‚
â”‚ + user_schema(): StructType                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DataLoader                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - spark: SparkSession                                        â”‚
â”‚ - data_path: str                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + __init__(spark, data_path)                                 â”‚
â”‚ + load_business_data(): DataFrame                            â”‚
â”‚ + load_review_data(): DataFrame                              â”‚
â”‚ + load_user_data(): DataFrame                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       YelpAnalytics                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ @staticmethod                                                â”‚
â”‚ + top_selling_products_recent(review_df, business_df, ...)   â”‚
â”‚ + user_purchase_patterns(review_df, ...)                     â”‚
â”‚ + top_users_by_reviews(review_df, user_df, ...)              â”‚
â”‚ + category_trends_over_time(business_df, review_df, ...)     â”‚
â”‚ + high_rating_low_review_businesses(business_df, review_df,..)â”‚
â”‚ + geographic_distribution(business_df, review_df, ...)       â”‚
â”‚ + seasonal_trends(review_df, business_df, ...)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AdvancedYelpAnalytics                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ @staticmethod                                                â”‚
â”‚ + trending_businesses(review_df, business_df, ...)           â”‚
â”‚ + category_performance_matrix(business_df, review_df, ...)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   YelpAnalysisPipeline                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - data_path: str                                             â”‚
â”‚ - output_path: str                                           â”‚
â”‚ - spark: SparkSession                                        â”‚
â”‚ - data_loader: DataLoader                                    â”‚
â”‚ - analytics: YelpAnalytics                                   â”‚
â”‚ - business_df: DataFrame                                     â”‚
â”‚ - review_df: DataFrame                                       â”‚
â”‚ - results: dict                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + __init__(data_path, output_path)                           â”‚
â”‚ + load_data()                                                â”‚
â”‚ + run_analysis_1/2/3/4/5/6/7(...)                            â”‚
â”‚ + run_all_analyses()                                         â”‚
â”‚ + save_results()                                             â”‚
â”‚ + stop()                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–³
                            â”‚ inherits
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  EnhancedYelpPipeline                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + run_analysis_8(...)                                        â”‚
â”‚ + run_analysis_9(...)                                        â”‚
â”‚ + run_all_analyses_v2()                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Data Schema - Cáº¥u trÃºc dá»¯ liá»‡u

### Business DataFrame Schema
```
business_df
â”œâ”€ business_id: string
â”œâ”€ name: string
â”œâ”€ address: string
â”œâ”€ city: string
â”œâ”€ state: string
â”œâ”€ postal_code: string
â”œâ”€ latitude: double
â”œâ”€ longitude: double
â”œâ”€ stars: double
â”œâ”€ review_count: integer
â”œâ”€ is_open: integer
â””â”€ categories: string (comma-separated)
```

### Review DataFrame Schema
```
review_df
â”œâ”€ review_id: string
â”œâ”€ user_id: string
â”œâ”€ business_id: string
â”œâ”€ stars: integer
â”œâ”€ useful: integer
â”œâ”€ funny: integer
â”œâ”€ cool: integer
â”œâ”€ text: string
â””â”€ date: timestamp
```

### Analysis Result Schemas

#### Analysis 8 Output (Trending Businesses)
```
trending_df
â”œâ”€ business_id: string
â”œâ”€ name: string
â”œâ”€ city: string
â”œâ”€ categories: string
â”œâ”€ week_start: date
â”œâ”€ weekly_count: bigint
â”œâ”€ prev_week_count: bigint       # lag()
â”œâ”€ growth_rate: double            # calculated
â”œâ”€ avg_last_4_weeks: double       # avg() over window
â””â”€ trend_rank: integer            # dense_rank()
```

#### Analysis 9 Output (Category Performance Matrix)

**Pivoted (Wide Format)**:
```
pivoted_df
â”œâ”€ category: string
â”œâ”€ Las Vegas: string              # "4.2 (523)"
â”œâ”€ Philadelphia: string           # "3.9 (341)"
â”œâ”€ Phoenix: string                # "4.5 (612)"
â”œâ”€ Tampa: string                  # "4.1 (287)"
â””â”€ Tucson: string                 # "4.3 (398)"
```

**Unpivoted (Long Format)**:
```
unpivoted_df
â”œâ”€ category: string
â”œâ”€ city: string
â””â”€ metrics: string                # "4.2 (523)"
```

---

## ğŸ¨ Visual Code Organization

```
ğŸ“‚ Spark_Batch/
â”‚
â”œâ”€â”€ ğŸšª ENTRY LAYER
â”‚   â”‚   Äiá»ƒm khá»Ÿi cháº¡y cho users
â”‚   â”‚
â”‚   â”œâ”€â”€ batch_main.py              CLI â†’ 7 analyses
â”‚   â””â”€â”€ batch_main_v2.py           CLI â†’ 9 analyses â­
â”‚
â”œâ”€â”€ ğŸ§  BUSINESS LOGIC LAYER
â”‚   â”‚   Core logic cá»§a á»©ng dá»¥ng
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ¯ Orchestration
â”‚   â”‚   â””â”€â”€ batch_pipeline.py     Äiá»u phá»‘i flow
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“Š Analytics
â”‚       â”œâ”€â”€ batch_analytics.py    7 analyses cÆ¡ báº£n
â”‚       â””â”€â”€ batch_analytics_advanced.py  2 analyses nÃ¢ng cao â­
â”‚
â”œâ”€â”€ ğŸ› ï¸ UTILITY LAYER
â”‚   â”‚   CÃ´ng cá»¥ há»— trá»£
â”‚   â”‚
â”‚   â””â”€â”€ batch_udf.py              7 custom UDFs â­
â”‚
â”œâ”€â”€ ğŸ’¾ DATA ACCESS LAYER
â”‚   â”‚   TÆ°Æ¡ng tÃ¡c vá»›i data
â”‚   â”‚
â”‚   â”œâ”€â”€ batch_configuration.py    Spark config & schemas
â”‚   â””â”€â”€ batch_load_data.py        Load JSON â†’ DataFrame
â”‚
â””â”€â”€ ğŸ§ª TESTING LAYER
    â”‚   Kiá»ƒm thá»­ & validation
    â”‚
    â””â”€â”€ test_local_features.py    Test 4 features â­
```

---

## ğŸš€ Execution Sequence - TrÃ¬nh tá»± thá»±c thi

### V2 Pipeline Full Execution
```
TIME â†’

T0: START
  â”‚
  â”œâ”€ Parse CLI arguments
  â””â”€ Print header

T1: INITIALIZE (5s)
  â”‚
  â”œâ”€ Create Spark Session
  â”‚   â”œâ”€ Configure memory (8GB driver)
  â”‚   â”œâ”€ Configure executor (4GB)
  â”‚   â””â”€ Enable AQE
  â”‚
  â””â”€ Initialize pipeline components

T2: LOAD DATA (30-60s)
  â”‚
  â”œâ”€ Load business.json (150K rows)
  â”œâ”€ Load review.json (7M rows)
  â””â”€ Cache DataFrames

T3: RUN ANALYSES (5-10 min)
  â”‚
  â”œâ”€ Analysis 1: Top Selling (15s)
  â”œâ”€ Analysis 2: User Patterns (20s)
  â”œâ”€ Analysis 3: Top Users (25s)
  â”œâ”€ Analysis 4: Category Trends (30s)
  â”œâ”€ Analysis 5: High Rating Low Review (10s)
  â”œâ”€ Analysis 6: Geographic (20s)
  â”œâ”€ Analysis 7: Seasonal (25s)
  â”œâ”€ Analysis 8: Trending (45s) â­ Window Functions
  â””â”€ Analysis 9: Performance Matrix (40s) â­ Pivot/Unpivot

T4: SAVE RESULTS (30s)
  â”‚
  â”œâ”€ Coalesce partitions
  â”œâ”€ Write CSV files
  â””â”€ Generate summary

T5: CLEANUP
  â”‚
  â”œâ”€ Stop Spark Session
  â”œâ”€ Print footer
  â””â”€ Exit

TOTAL: ~7-12 minutes
```

---

## ğŸ¯ SUMMARY - TÃ³m táº¯t kiáº¿n trÃºc

### NguyÃªn táº¯c thiáº¿t káº¿
1. âœ… **Separation of Concerns**: Má»—i layer cÃ³ trÃ¡ch nhiá»‡m riÃªng
2. âœ… **Modularity**: Má»—i module cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘á»™c láº­p
3. âœ… **Extensibility**: Dá»… dÃ ng thÃªm analyses má»›i
4. âœ… **Inheritance**: Káº¿ thá»«a Ä‘á»ƒ má»Ÿ rá»™ng functionality
5. âœ… **Static Methods**: Analytics khÃ´ng cáº§n state

### Design Patterns sá»­ dá»¥ng
- **Factory Pattern**: `SparkConfig.create_spark_session()`
- **Builder Pattern**: Pipeline orchestration
- **Strategy Pattern**: Multiple analytics strategies
- **Template Method**: `run_all_analyses()` flow

### Performance Optimizations
- âœ… Broadcast Join cho small tables
- âœ… DataFrame Caching cho reuse
- âœ… Pandas UDF cho vectorization
- âœ… Adaptive Query Execution
- âœ… Kryo Serialization

---

**SÆ¡ Ä‘á»“ nÃ y giÃºp báº¡n hiá»ƒu rÃµ cÃ¡ch cÃ¡c module tÆ°Æ¡ng tÃ¡c vá»›i nhau!**

Äá»ƒ xem chi tiáº¿t tá»«ng module, Ä‘á»c **PROJECT_STRUCTURE.md**
Äá»ƒ báº¯t Ä‘áº§u nhanh, Ä‘á»c **README.md**
